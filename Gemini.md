# Mass战争迷雾系统：总体设计目标

## 核心哲学

以“Winyunq”原则为指导，通过采用数据驱动的Mass框架，构建一个可支撑数十万单位的超大规模战争迷雾系统，旨在实现性能与功能的指数级增长。

## 系统架构总目标

将现有基于Actor Component的架构，彻底重构为基于Mass框架的**标签（Tags）**、**片段（Fragments）**和**处理器（Processors）**的现代数据驱动架构。

### 1. 实体定义

- **核心思想**: 游戏世界中的所有“单位”都将被视为Mass实体。其在战争迷雾系统中的角色（提供视野、被动可见等）完全由附加的**Tags**和**Fragments**定义。
- **关键数据**:
    - **Tags**: `FMassVisionEntityTag`, `FMassVisibleEntityTag`, `FMassStationaryTag`, `FMassMinimapVisibleTag`。
    - **Fragments**: `FMassVisionFragment` (存视野半径), `FMassWorldPositionFragment` (存世界位置)。

### 2. LOD分层架构：分块矩阵

- **核心思想**: 将整个世界地图视为一个巨大的分块矩阵（或四叉树）。该结构分为多个LOD层级，但每一层的基本单元都是一个`16x16`的网格。
- **层级定义**:
    - **LOD 0**: `16x16`，最基础的数据单元。
    - **LOD 1**: `256x256` (由16x16个LOD 0块构成)。适用于小地图。
    - **LOD 2**: `4096x4096` (由16x16个LOD 1块构成)。
    - **LOD 3**: `65536x65536` (由16x16个LOD 2块构成)。适用于高精度游戏视野。
- **优势**: 算法具有尺度不变性。无论是更新一个LOD 0的局部，还是更新LOD 3的宏观区域，其逻辑都是在`16x16`的网格上操作，极大简化了算法复杂性。

### 3. 计算与缓存优化

- **核心思想**: 只有“变化”才产生计算。系统的设计应最大限度地避免冗余计算。
- **实现路径**:
    - **动静分离**: 通过`FMassStationaryTag`区分静态与动态单位。静态单位的视野信息在初始化后即被缓存，除非被外部强制刷新，否则不参与后续帧的计算。
    - **增量更新**: Mass Processor仅查询位置发生变化的实体（通过`FMassLocationChangedTag`识别），并只对这些实体进行视野计算。
    - **局部更新**: 视野计算的结果将精确地更新到LOD分块矩阵中的对应格子，避免无效的全局刷新。

通过以上设计，最终交付一个高性能、高扩展性、且能满足未来战略游戏需求的战争迷雾系统。
